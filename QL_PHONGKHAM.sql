USE master
GO
IF EXISTS(SELECT * FROM sys.databases WHERE name='QL_PHONGKHAM')
BEGIN
        DROP DATABASE QL_PHONGKHAM
END
CREATE DATABASE QL_PHONGKHAM
GO
USE QL_PHONGKHAM
GO
-- TẠO BẢNG 
CREATE TABLE QUYEN
(
    MAQUYEN INT IDENTITY NOT NULL PRIMARY KEY,
    TENQUYEN NVARCHAR(50),
    CODE CHAR(2)
)

CREATE TABLE MANHINH
(
    ID VARCHAR(15) NOT NULL PRIMARY KEY,
    TENMH NVARCHAR(50)
)

CREATE TABLE QL_PHANQUYEN
(
    MAQUYEN INT REFERENCES QUYEN(MAQUYEN) NOT NULL,
    ID_MH VARCHAR(15) REFERENCES MANHINH(ID) NOT NULL,
    COQUYEN BIT NOT NULL,
    CONSTRAINT PK_PQ PRIMARY KEY (MAQUYEN, ID_MH)
)

CREATE TABLE TAIKHOAN (
    ID VARCHAR(20) NOT NULL, -- CREATE AUTO
    USERNAME VARCHAR(50), -- CHECK USERNAME THEO GROUP
    PW VARCHAR(50),
    CONSTRAINT PK_TK PRIMARY KEY (ID)
)
CREATE TABLE NHOMNGUOIDUNG
(
    ID_Q INT REFERENCES QUYEN(MAQUYEN),
    ID_TK VARCHAR(20) REFERENCES TAIKHOAN(ID),
    CONSTRAINT PK_NND PRIMARY KEY (ID_Q, ID_TK)
)

CREATE TABLE NHOMCHUYENNGANH(
	MACN VARCHAR(10) NOT NULL PRIMARY KEY,
	TENCN NVARCHAR(50)
)
CREATE TABLE THONGTINTAIKHOAN (
    ID VARCHAR(20) NOT NULL, -- CREATE AUTO
    HOTEN NVARCHAR(50), -- HỌ TÊN
    NGSINH DATE, -- NGÀY SINH
    GTINH NVARCHAR(10),
    SDT VARCHAR(11), -- SDT
    DCHI NVARCHAR(50), -- ĐỊA CHỈ NHÀ / ĐỊA CHỈ GIAO
    ID_TAIKHOAN VARCHAR(20) REFERENCES TAIKHOAN(ID) unique,
    CONSTRAINT PK_TTTK PRIMARY KEY (ID)
)
CREATE TABLE NHANVIEN(
	MANV VARCHAR(10) NOT NULL PRIMARY KEY,
    ID VARCHAR(20) REFERENCES TAIKHOAN(ID) unique
)
CREATE TABLE PHONG 
(
	MAPHONG VARCHAR(10) NOT NULL PRIMARY KEY,
	TENPHONG NVARCHAR(50),
)
CREATE TABLE BACSI(
	MABS VARCHAR(20), 
    IDTK VARCHAR(20) REFERENCES TAIKHOAN(ID) unique,
	MACN VARCHAR(10) REFERENCES NHOMCHUYENNGANH(MACN),
	MAPHONG VARCHAR(10)  REFERENCES PHONG(MAPHONG),
	CONSTRAINT PK_BACSI PRIMARY KEY (MABS)
)
CREATE TABLE BENHNHAN(
	MABN VARCHAR(20) NOT NULL PRIMARY KEY,
	TENBN NVARCHAR(50),
	NGAYSINH DATE,
	GTINH NVARCHAR(10),
	DIACHI NVARCHAR(50),
	SDT VARCHAR(15)
)
CREATE TABLE DICHVU(
	MADV VARCHAR(10) NOT NULL PRIMARY KEY,
	TENDV NVARCHAR(50),
)

CREATE TABLE DMTHUOC(
	MAT VARCHAR(20) NOT NULL PRIMARY KEY,
	TENTHUOC NVARCHAR(50),
	HSD NVARCHAR(50),
	SOLUONG INT,
	DONVITINH VARCHAR(20)
)
CREATE TABLE DONGIA_THUOC(
	MAT VARCHAR(20) REFERENCES DMTHUOC(MAT),
	NGCAPNHAT DATE,
	GIA FLOAT,
	CONSTRAINT PK_DONGIA_THUOC PRIMARY KEY (MAT,NGCAPNHAT)
)
CREATE TABLE DONGIA_DICHVU(
	MADV VARCHAR(10) REFERENCES DICHVU(MADV),
	NGCAPNHAT DATE,
	GIA FLOAT,
	CONSTRAINT PK_DONGIA_DV PRIMARY KEY (MADV,NGCAPNHAT)
)
CREATE TABLE LS_KHAMBENH(
	MALS VARCHAR(20),
	MABN VARCHAR(20) REFERENCES BENHNHAN(MABN),
	MABS VARCHAR(20) REFERENCES BACSI(MABS),
	NGKHAM DATE,
	STT INT,
	CHANDOAN NVARCHAR(50),
	TRANGTHAI BIT,
	CONSTRAINT PK_LSKB PRIMARY KEY (MALS)
)
CREATE TABLE TOATHUOC(
	MATT VARCHAR(20) NOT NULL PRIMARY KEY,
	MALS VARCHAR(20) REFERENCES LS_KHAMBENH(MALS) unique,
	TRANGTHAI BIT,
	TONGTIENTT FLOAT
)
CREATE TABLE CT_TOATHUOC(
	MATT VARCHAR(20) REFERENCES TOATHUOC(MATT),
	MAT VARCHAR(20) REFERENCES DMTHUOC(MAT),
	SOBUOI INT,
	SOLUONGUONG INT,
	TONGSOLUONG INT,
	DONGIA FLOAT,
	CONSTRAINT PK_CT_TOATHUOC PRIMARY KEY (MATT, MAT)
)
CREATE TABLE PHIEUCHIDINH(
	MACD VARCHAR(20) NOT NULL,
	MALS VARCHAR(20) REFERENCES LS_KHAMBENH(MALS) unique,
	TRANGTHAI BIT,
	TONGTIENDV FLOAT,
	CONSTRAINT PK_PCD PRIMARY KEY (MACD)
)
CREATE TABLE CHITIETCD(
	MACD VARCHAR(20) REFERENCES PHIEUCHIDINH(MACD),
	MADV VARCHAR(10) REFERENCES DICHVU(MADV),
	MOTA NVARCHAR(MAX),
	KETQUA NVARCHAR(MAX),
	HINHANH NVARCHAR(MAX),
	CONSTRAINT PK_CTDONDV PRIMARY KEY (MACD, MADV)
)

CREATE TABLE CT_DICHVU
(
	MACTDV VARCHAR(10)  PRIMARY KEY,
	MADV VARCHAR(10) REFERENCES DICHVU(MADV),
	TEN_CTDV NVARCHAR(MAX)
)

GO
CREATE FUNCTION fn_PhanQuyen(@idGR INT)
RETURNS TABLE
AS
	RETURN SELECT ID, TENMH, COQUYEN
	FROM MANHINH MH LEFT JOIN QL_PHANQUYEN PQ
		ON MH.ID = PQ.ID_MH AND MAQUYEN = @idGR
GO

--DATA
INSERT TAIKHOAN
VALUES
('TK001','admin','123'),
('TK002','bacsi','123'),
('TK003','nhanvientn','123'),
('TK004','nvthungan','123'),
('TK005','bacsidv','123')

-- BẢNG TB_GRTK
INSERT QUYEN VALUES(N'ADMIN', '00')
INSERT QUYEN VALUES(N'USER', '01')
INSERT QUYEN VALUES(N'BACSI', '02')

INSERT MANHINH VALUES('M1', N'Quản lý bệnh nhân')
INSERT MANHINH VALUES('M2', N'Thanh toán dịch vụ')
INSERT MANHINH VALUES('M3', N'Quản lý tài khoản')
INSERT MANHINH VALUES('M4', N'Thực hiện dịch vụ')
INSERT MANHINH VALUES('M5', N'Thanh toán toa thuốc')
INSERT MANHINH VALUES('M6', N'Phân quyền') 
INSERT MANHINH VALUES('M7', N'Quản lý nhóm người dùng') 
INSERT MANHINH VALUES('M8', N'Thêm người dùng vào nhóm')
INSERT MANHINH VALUES('M9', N'Khám bệnh')
INSERT MANHINH VALUES('MMH', N'Quản lý màn hình')
INSERT MANHINH VALUES('MDM', N'Quản lý danh mục thuốc')

INSERT NHOMNGUOIDUNG VALUES ('1','TK001')
INSERT NHOMNGUOIDUNG VALUES ('3','TK002')
INSERT NHOMNGUOIDUNG VALUES ('2','TK003')
INSERT NHOMNGUOIDUNG VALUES ('2','TK004')
INSERT NHOMNGUOIDUNG VALUES ('3','TK005')

-- bảng phân quyền
-- phân quyền cho admin
INSERT QL_PHANQUYEN VALUES 
(1, 'M1', 1),
(1, 'M2', 0),
(1, 'M3', 1),
(1, 'M4', 0),
(1, 'M5', 0),
(1, 'M6', 1),
(1, 'M7', 1),
(1, 'M8', 1),
(1, 'M9', 0),
(1, 'MMH', 1),
(1, 'MDM', 1)

-- phân quyền cho bác sĩ
INSERT QL_PHANQUYEN VALUES 
(3, 'M1', 0),
(3, 'M2', 1),
(3, 'M3', 0),
(3, 'M4', 1),
(3, 'M5', 1),
(3, 'M6', 0),
(3, 'M7', 0),
(3, 'M8', 0),
(3, 'M9', 1),
(3, 'MMH', 0),
(3, 'MDM', 0)

-- phân quyền cho nhân viên
INSERT QL_PHANQUYEN VALUES 
(2, 'M1', 1),
(2, 'M2', 0),
(2, 'M3', 0),
(2, 'M4', 0),
(2, 'M5', 1),
(2, 'M6', 0),
(2, 'M7', 0),
(2, 'M8', 0),
(2, 'M9', 0),
(2, 'MMH', 0),
(2, 'MDM', 1)
INSERT PHONG 
VALUES 
('P01',N'PHÒNG 401'),
('P02',N'PHÒNG 402'),
('P03',N'PHÒNG 403')

INSERT NHOMCHUYENNGANH
VALUES
('CN001',N'CHUYÊN NGÀNH NHI'),
('CN002',N'CHUYÊN NGÀNH TỔNG QUÁT')

SET DATEFORMAT DMY
INSERT BENHNHAN 
VALUES
('BN01',N'Vũ Hương Ly','09/01/2001',N'Nữ',N'18 Hoài Đức','0965320413'),
('BN02',N'Phạm Hải Yến','02/07/2001',N'Nữ','19 Cầu Giấy','0965320423'),
('BN03',N'Phan Nhật Ánh','05/07/2001',N'Nữ',N'654 Đà nẵng','0975320423'),
('BN04',N'Phan Nhật Anh','05/09/2001',N'Nữ',N'650 Đà nẵng','0565320423'),
('BN05',N'Vũ Kim Lan','05/06/2001',N'Nữ',N'658 Quy Nhơn','0964520423'),
('BN06',N'Bùi Minh Tuấn','06/02/2001',N'Nữ',N'658 Cầu Giấy','0989320423'),
('BN07',N'Vũ Chí Minh','09/01/2001',N'Nam',N'45 Hoài Đức','0989320445'),
('BN07',N'Phạm Minh Bình','02/07/2001',N'Nam',N'58 Cầu Giấy','0989320345'),
('BN08',N'Phạm Minh Chí','02/09/2001',N'Nam',N'163 Lê Trọng Tấn','0989320341'),
('BN08',N'Trần Chí Thành','02/07/2001',N'Nam',N'76 Nguyễn Trãi','0989320341'),
('BN09',N'Trần Chí Bình','02/08/2001',N'Nam',N'78 Nguyễn Trãi','0989320741'),
('BN10',N'Trần Vĩ Hào','02/05/2001',N'Nam',N'110 Nguyễn Trãi','0669320341')


SET DATEFORMAT DMY
INSERT THONGTINTAIKHOAN 
VALUES
('TK01',N'Vũ Ngọc Diệp','01/02/1985',N'Nữ','0965320417',N'160 Long Biên','TK002'),
('TK02',N'Bùi Mai Hương','01/06/1978',N'Nữ','0965320416',N'150 Sóc Sơn','TK005')
INSERT BACSI
VALUES
('BS001','TK002','CN002','P01'),
('BS002','TK005','CN001','P02')
INSERT DICHVU
VALUES
('DV001',N'XÉT NGHIỆM MÁU'),
('DV002',N'SIÊU ÂM'),
('DV003',N'CHỤP X QUANG'),
('DV004',N'KHÁM BỆNH LÂM SÀN')


INSERT CT_DICHVU
VALUES
('DV1','DV001',N'Xét nghiệm công thức máu toàn phần (CBC)'),
('DV2','DV001',N'Xét nghiệm sinh hóa máu'),
('DV3','DV002',N'Siêu âm 3D'),
('DV4','DV002',N'Siêu âm 4D'),
('DV5','DV002',N'Siêu âm Doppler'),
('DV6','DV002',N'Siêu âm tim'),
('DV7','DV002',N'Siêu âm trị liệu'),
('DV8','DV002',N'Siêu âm ổ bụng'),
('DV9','DV002',N'Siêu âm đầu dò'),
('DV10','DV002',N'Siêu âm tử cung phần phụ'),
('DV11','DV003',N'Chụp x quang xương cảng chân thẳng'),
('DV12','DV003',N'Chụp x quang xương ức thẳng, nghiêng'),
('DV13','DV003',N'Chụp x quang đỉnh phổi ưỡn'),
('DV14','DV003',N'Chụp x quang mỏm trâm'),
('DV15','DV003',N'Chụp x quang cột sống'),
('DV16','DV003',N'Chụp x quang cánh tay'),
('DV17','DV003',N'Chụp x quang khớp háng'),
('DV18','DV003',N'Chụp x quang xương đùi'),
('DV19','DV003',N'Chụp x quang khớp gối')

SET DATEFORMAT DMY
INSERT DONGIA_DICHVU
VALUES
('DV001','08/05/2022',400000),
('DV002','02/09/2022',200000),
('DV003','03/05/2021',250000),
('DV004','06/05/2021',300000)

INSERT DMTHUOC
VALUES
('T001','Paracetamol 20mg',N'12 THÁNG',100,N'VIÊN'),
('T002','Ibuprofen 60mg',N'12 THÁNG',100,N'VIÊN'),
('T003','Meloxicam 70mg',N'12 THÁNG',100,N'VIÊN'),
('T004','Celecoxib 80mg',N'12 THÁNG',100,N'VIÊN'),
('T005','Piroxicam 100mg',N'12 THÁNG',100,N'VIÊN'),
('T006','Prednisolon 1000mg',N'12 THÁNG',100,N'VIÊN'),
('T007','Methylprednisolon 90mg',N'12 THÁNG',100,N'VIÊN'),
('T008','Amoxicillin  85mg',N'12 THÁNG',100,N'VIÊN'),
('T009','Ampicillin 72mg',N'12 THÁNG',100,N'VIÊN'),
('T010','Cefpodoxime 65mg',N'12 THÁNG',100,N'VIÊN'),
('T011','Cefuroxime 25mg',N'12 THÁNG',100,N'VIÊN'),
('T012','Cefixime 10mg',N'12 THÁNG',100,N'VIÊN'),
('T013','Cefnidir  20mg',N'12 THÁNG',100,N'VIÊN'),
('T014','Cephalexin 52mg',N'12 THÁNG',100,N'VIÊN'),
('T015','Alimemazin 20mg',N'12 THÁNG',100,N'VIÊN'),
('T016','Loratadin 40mg',N'12 THÁNG',100,N'VIÊN'),
('T017','Chlorpheniramin 20mg',N'12 THÁNG',100,N'VIÊN'),
('T018','Fexofenadin 80mg',N'12 THÁNG',100,N'VIÊN'),
('T019','Cetirizine 56mg',N'12 THÁNG',100,N'VIÊN'),
('T020','Omeprazol 46mg',N'12 THÁNG',100,N'VIÊN'),
('T021','Esomeprazol 78mg',N'12 THÁNG',100,N'VIÊN'),
('T022','Pantoprazol 80mg',N'12 THÁNG',100,N'VIÊN'),
('T023','Rabeprazol 75mg',N'12 THÁNG',100,N'VIÊN'),
('T024','Domperidol 56mg',N'12 THÁNG',100,N'VIÊN'),
('T025','Lansoprazol 89mg',N'12 THÁNG',100,N'VIÊN'),
('T026','Domitazol 45mg',N'12 THÁNG',100,N'VIÊN'),
('T027','Rigevidon 56mg',N'12 THÁNG',100,N'VIÊN'),
('T028','Itraconazol 56mg',N'12 THÁNG',100,N'VIÊN'),
('T029','Fluconazol 56mg',N'12 THÁNG',100,N'VIÊN'),
('T030','Pharmaton 56mg',N'12 THÁNG',100,N'VIÊN'),
('T031','Boganic 45mg',N'12 THÁNG',100,N'VIÊN'),
('T032','Rowatinex 75mg',N'12 THÁNG',100,N'VIÊN'),
('T033','Decolgen 10mg',N'12 THÁNG',100,N'VIÊN'),
('T034','Daflon 10mg',N'12 THÁNG',100,N'VIÊN'),
('T035','Bisacodyl 10mg',N'12 THÁNG',100,N'VIÊN'),
('T036','Canesten 30mg',N'12 THÁNG',100,N'VIÊN'),
('T037','Bisolvon 30mg',N'12 THÁNG',100,N'VIÊN'),
('T038','Biotin Collagen 30mg ',N'12 THÁNG',100,N'VIÊN'),
('T039','Polygynax 46mg',N'12 THÁNG',100,N'VIÊN'),
('T040','Sorbitol 46mg',N'12 THÁNG',100,N'VIÊN'),
('T041','Alaxan 46mg',N'12 THÁNG',100,N'VIÊN'),
('T042','Homtamin 46mg',N'12 THÁNG',100,N'VIÊN'),
('T043','Zentel 46mg',N'12 THÁNG',100,N'VIÊN'),
('T044','Calcium Corbiere 85mg',N'12 THÁNG',100,N'VIÊN'),
('T045','Nystatin 75mg',N'12 THÁNG',100,N'VIÊN'),
('T046','Mercilon 46mg',N'12 THÁNG',100,N'VIÊN'),
('T047','Buscopan 46mg',N'12 THÁNG',100,N'VIÊN'),
('T048','Maalox 46mg',N'12 THÁNG',100,N'VIÊN'),
('T049','Stugon 55mg',N'12 THÁNG',100,N'VIÊN'),
('T050','Lactomin 55mg',N'12 THÁNG',100,N'VIÊN'),
('T051','Pectol 55mg',N'12 THÁNG',100,N'CHAI'),
('T052','Cadumarin Fort 55mg',N'12 THÁNG',100,N'CHAI'),
('T053','Atussin 75mg',N'12 THÁNG',100,N'CHAI'),
('T054','Ventolin 1000mg',N'12 THÁNG',100,N'CHAI'),
('T055','Mouthpaste 76mg',N'12 THÁNG',100,N'CHAI'),
('T056','Daktarin 89mg',N'12 THÁNG',100,N'CHAI'),
('T057','Neodex 56mg',N'12 THÁNG',100,N'CHAI'),
('T058','Tobradex  56mg',N'12 THÁNG',100,N'CHAI'),
('T059','Griseofulvin 56mg',N'12 THÁNG',100,N'CHAI'),
('T060','Newchoi 56mg',N'12 THÁNG',100,N'VIÊN')


SET DATEFORMAT DMY
INSERT DONGIA_THUOC
VALUES
('T001','07/05/2022',170000),
('T002','06/05/2022',180000),
('T003','03/05/2022',190000),
('T004','02/05/2022',160000),
('T005','01/05/2022',150000),
('T006','08/06/2022',140000),
('T007','08/08/2022',120000),
('T008','08/09/2022',110000),
('T009','08/02/2022',100000),
('T010','08/04/2022',180000),
('T011','08/02/2022',190000),
('T012','08/03/2022',120000),
('T013','08/04/2022',140000),
('T014','08/08/2022',160000),
('T015','08/09/2022',160000),
('T016','08/05/2022',170000),
('T017','01/05/2022',120000),
('T018','02/05/2022',130000),
('T019','06/05/2022',140000),
('T020','09/05/2022',150000),
('T021','08/05/2022',150000),
('T022','03/05/2022',170000),
('T023','05/05/2022',180000),
('T024','07/05/2022',190000),
('T025','05/05/2022',100000),
('T026','08/05/2022',120000),
('T027','09/05/2022',110000),
('T028','01/05/2022',170000),
('T029','02/02/2022',140000),
('T030','03/01/2022',120000),
('T031','04/03/2022',130000),
('T032','05/01/2022',150000),
('T033','07/02/2022',150000),
('T034','09/08/2022',150000),
('T035','02/07/2022',160000),
('T036','05/07/2022',180000),
('T037','04/06/2022',180000),
('T038','04/06/2022',190000),
('T039','05/06/2022',180000),
('T040','06/07/2022',110000),
('T041','06/07/2022',1130000),
('T042','06/07/2022',130000),
('T043','06/07/2022',150000),
('T044','06/07/2022',140000),
('T045','06/07/2022',130000),
('T046','06/07/2022',120000),
('T047','06/07/2022',170000),
('T048','01/04/2022',160000),
('T049','02/05/2022',150000),
('T050','03/04/2022',140000),
('T051','04/09/2022',120000),
('T052','05/09/2022',110000),
('T053','06/09/2022',180000),
('T054','08/08/2022',170000),
('T055','09/06/2022',160000),
('T056','01/04/2022',150000),
('T057','03/02/2022',140000),
('T058','07/09/2022',130000),
('T059','09/02/2022',120000),
('T060','03/01/2022',160000)

select * from DICHVU
select * from DONGIA_DICHVU
select * from DMTHUOC
select * from CHITIETCD
select * from CT_DICHVU
